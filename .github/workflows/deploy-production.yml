# .github/workflows/deploy-production.yml
name: Deploy to Production

on:
  push:
    tags:
      - 'v*' # –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–µ–≥–∏ v1.0.0, v1.2.3 –∏ —Ç.–¥.
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    inputs:
      version:
        description: '–í–µ—Ä—Å–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è (—Ç–µ–≥)'
        required: true
        default: 'latest'

env:
  SSH_HOST: ${{ secrets.PRODUCTION_SSH_HOST }}
  SSH_USER: ${{ secrets.PRODUCTION_SSH_USER }}
  SSH_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
  DEPLOY_PATH: /var/www/catalog-production
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ env.VERSION }}
        
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}
        
    - name: Configure SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.PRODUCTION_SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Get version info
      id: version
      run: |
        if [[ "${{ env.VERSION }}" == "latest" ]]; then
          echo "TAG=latest" >> $GITHUB_OUTPUT
          echo "VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo 'latest')" >> $GITHUB_OUTPUT
        else
          echo "TAG=${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "VERSION=${{ env.VERSION }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push production image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/php-fpm/Dockerfile.prod
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:production-${{ steps.version.outputs.VERSION }}
          ghcr.io/${{ github.repository }}:production-latest
        labels: |
          org.opencontainers.image.title=${{ github.event.repository.name }}
          org.opencontainers.image.description=${{ github.event.repository.description }}
          org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
          org.opencontainers.image.created=${{ github.event.repository.created_at }}
          org.opencontainers.image.source=${{ github.event.repository.html_url }}
          org.opencontainers.image.authors=${{ github.event.repository.owner.login }}
        
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_SSH_HOST }}
        username: ${{ secrets.PRODUCTION_SSH_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          set -e
          
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ production..."
          echo "–í–µ—Ä—Å–∏—è: ${{ steps.version.outputs.VERSION }}"
          
          # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
          cd ${{ env.DEPLOY_PATH }}
          ./scripts/backup.sh
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker-compose -f docker-compose.prod.yml down
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑
          docker pull ghcr.io/${{ github.repository }}:production-${{ steps.version.outputs.VERSION }}
          
          # –û–±–Ω–æ–≤–ª—è–µ–º docker-compose.prod.yml
          cat > docker-compose.prod.yml << 'DOCKER_COMPOSE'
          version: '3.8'
          
          services:
            php-fpm:
              image: ghcr.io/${{ github.repository }}:production-${{ steps.version.outputs.VERSION }}
              restart: always
              environment:
                APP_ENV: production
                APP_DEBUG: false
                APP_URL: ${{ secrets.PRODUCTION_APP_URL }}
                DB_HOST: postgres
                DB_DATABASE: ${{ secrets.PRODUCTION_DB_DATABASE }}
                DB_USERNAME: ${{ secrets.PRODUCTION_DB_USERNAME }}
                DB_PASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}
                REDIS_HOST: redis
                MEILISEARCH_HOST: http://meilisearch:7700
                MEILISEARCH_KEY: ${{ secrets.PRODUCTION_MEILISEARCH_KEY }}
                MAIL_MAILER: ${{ secrets.PRODUCTION_MAIL_MAILER }}
                MAIL_HOST: ${{ secrets.PRODUCTION_MAIL_HOST }}
                MAIL_PORT: ${{ secrets.PRODUCTION_MAIL_PORT }}
                MAIL_USERNAME: ${{ secrets.PRODUCTION_MAIL_USERNAME }}
                MAIL_PASSWORD: ${{ secrets.PRODUCTION_MAIL_PASSWORD }}
                TELEGRAM_BOT_TOKEN: ${{ secrets.PRODUCTION_TELEGRAM_BOT_TOKEN }}
                TELEGRAM_CHAT_ID: ${{ secrets.PRODUCTION_TELEGRAM_CHAT_ID }}
              volumes:
                - ./storage:/var/www/html/storage
                - ./bootstrap/cache:/var/www/html/bootstrap/cache
                - ./docker/php-fpm/php-prod.ini:/usr/local/etc/php/conf.d/custom.ini
              networks:
                - catalog-network
                
            nginx:
              image: nginx:1.24-alpine
              restart: always
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./docker/nginx/production.conf:/etc/nginx/nginx.conf:ro
                - ./docker/nginx/ssl:/etc/nginx/ssl:ro
                - ./storage/logs:/var/log/nginx
              networks:
                - catalog-network
                
            postgres:
              image: postgres:15-alpine
              restart: always
              environment:
                POSTGRES_DB: ${{ secrets.PRODUCTION_DB_DATABASE }}
                POSTGRES_USER: ${{ secrets.PRODUCTION_DB_USERNAME }}
                POSTGRES_PASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}
              volumes:
                - postgres_data:/var/lib/postgresql/data
                - ./database/backups:/backups
              networks:
                - catalog-network
                
            redis:
              image: redis:7-alpine
              restart: always
              command: redis-server --appendonly yes --save 900 1 --save 300 10 --save 60 10000
              volumes:
                - redis_data:/data
              networks:
                - catalog-network
                
            meilisearch:
              image: getmeili/meilisearch:v1.7
              restart: always
              environment:
                MEILI_MASTER_KEY: ${{ secrets.PRODUCTION_MEILISEARCH_KEY }}
                MEILI_ENV: production
              volumes:
                - meilisearch_data:/meili_data
              networks:
                - catalog-network
                
          volumes:
            postgres_data:
            redis_data:
            meilisearch_data:
            
          networks:
            catalog-network:
              driver: bridge
          DOCKER_COMPOSE
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker-compose -f docker-compose.prod.yml up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 30
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          if ! curl -f http://localhost/health 2>/dev/null | grep -q "healthy"; then
            echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å"
            exit 1
          fi
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
          echo "üóÑÔ∏è  –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan migrate --force --no-interaction
          
          # –û—á–∏—â–∞–µ–º –∫—ç—à
          echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à..."
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan optimize:clear
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan config:cache
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan route:cache
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan view:cache
          
          # –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
          echo "üîç –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞..."
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan scout:import "App\\Models\\Product" || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã"
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan scout:import "App\\Models\\PortfolioCase" || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–µ–π—Å—ã"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –æ—á–µ—Ä–µ–¥–∏
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –æ—á–µ—Ä–µ–¥–∏..."
          docker-compose -f docker-compose.prod.yml exec -T php-fpm php artisan queue:restart
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ production –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
    - name: Send deployment notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üöÄ –î–µ–ø–ª–æ–π –Ω–∞ Production
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –í–µ—Ä—Å–∏—è: ${{ steps.version.outputs.VERSION }}
          –°—Ç–∞—Ç—É—Å: ‚úÖ –£—Å–ø–µ—à–Ω–æ
          –°—Å—ã–ª–∫–∞: ${{ secrets.PRODUCTION_APP_URL }}
          –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')
          
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
          
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω GitHub Actions.
          
          ### –î–µ—Ç–∞–ª–∏ –¥–µ–ø–ª–æ—è
          - –í–µ—Ä—Å–∏—è: ${{ github.ref_name }}
          - –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')
          - –ö–æ–º–º–∏—Ç: ${{ github.sha }}
          
          ### –ü—Ä–æ–≤–µ—Ä–∫–∏
          - ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
          - ‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω
          - ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ production –≤—ã–ø–æ–ª–Ω–µ–Ω
        draft: false
        prerelease: false