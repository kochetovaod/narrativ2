# .github/workflows/deploy-staging.yml
name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
    inputs:
      version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ'
        required: false
        default: 'latest'

env:
  SSH_HOST: ${{ secrets.STAGING_SSH_HOST }}
  SSH_USER: ${{ secrets.STAGING_SSH_USER }}
  SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
  DEPLOY_PATH: /var/www/catalog-staging
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}
        
    - name: Configure SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.STAGING_SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/php-fpm/Dockerfile.prod
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:staging-${{ github.sha }}
          ghcr.io/${{ github.repository }}:staging-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Deploy to Staging Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_SSH_HOST }}
        username: ${{ secrets.STAGING_SSH_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          set -e
          
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° staging..."
          
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          cd ${{ env.DEPLOY_PATH }}
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          docker-compose down || true
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ docker-compose.yml
          cat > docker-compose.staging.yml << 'DOCKER_COMPOSE'
          version: '3.8'
          
          services:
            php-fpm:
              image: ghcr.io/${{ github.repository }}:staging-${{ github.sha }}
              restart: always
              environment:
                APP_ENV: staging
                APP_DEBUG: true
                APP_URL: https://staging.catalog.local
                DB_HOST: postgres
                DB_DATABASE: ${{ secrets.STAGING_DB_DATABASE }}
                DB_USERNAME: ${{ secrets.STAGING_DB_USERNAME }}
                DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
                REDIS_HOST: redis
                MEILISEARCH_HOST: http://meilisearch:7700
                MEILISEARCH_KEY: ${{ secrets.STAGING_MEILISEARCH_KEY }}
              volumes:
                - ./storage:/var/www/html/storage
                - ./bootstrap/cache:/var/www/html/bootstrap/cache
              networks:
                - catalog-network
                
            nginx:
              image: nginx:1.24-alpine
              restart: always
              ports:
                - "8080:80"
              volumes:
                - ./docker/nginx/staging.conf:/etc/nginx/nginx.conf:ro
                - ./storage/logs:/var/log/nginx
              networks:
                - catalog-network
                
            postgres:
              image: postgres:15-alpine
              restart: always
              environment:
                POSTGRES_DB: ${{ secrets.STAGING_DB_DATABASE }}
                POSTGRES_USER: ${{ secrets.STAGING_DB_USERNAME }}
                POSTGRES_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
              volumes:
                - postgres_data:/var/lib/postgresql/data
                - ./database/backups:/backups
              networks:
                - catalog-network
                
            redis:
              image: redis:7-alpine
              restart: always
              command: redis-server --appendonly yes
              volumes:
                - redis_data:/data
              networks:
                - catalog-network
                
            meilisearch:
              image: getmeili/meilisearch:v1.7
              restart: always
              environment:
                MEILI_MASTER_KEY: ${{ secrets.STAGING_MEILISEARCH_KEY }}
                MEILI_ENV: staging
              volumes:
                - meilisearch_data:/meili_data
              networks:
                - catalog-network
                
          volumes:
            postgres_data:
            redis_data:
            meilisearch_data:
            
          networks:
            catalog-network:
              driver: bridge
          DOCKER_COMPOSE
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          docker-compose -f docker-compose.staging.yml up -d
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° PHP
          sleep 10
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
          docker-compose -f docker-compose.staging.yml exec -T php-fpm php artisan migrate --force
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ
          docker-compose -f docker-compose.staging.yml exec -T php-fpm php artisan optimize:clear
          
          # Ð˜Ð½Ð´ÐµÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°
          docker-compose -f docker-compose.staging.yml exec -T php-fpm php artisan scout:import "App\\Models\\Product" || true
          docker-compose -f docker-compose.staging.yml exec -T php-fpm php artisan scout:import "App\\Models\\PortfolioCase" || true
          
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° staging Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          
    - name: Send deployment notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° Staging
          Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}
          Ð’ÐµÑ€ÑÐ¸Ñ: ${{ github.sha }}
          Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾
          Ð¡ÑÑ‹Ð»ÐºÐ°: ${{ secrets.STAGING_APP_URL }}
          Ð’Ñ€ÐµÐ¼Ñ: ${{ steps.deploy.outcome }}