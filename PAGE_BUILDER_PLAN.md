# План выполнения задачи №5: Page Builder и глобальные блоки

## Анализ текущего состояния

### ✅ Что уже есть

- Модели: Page, GlobalBlock
- Миграции: таблицы pages и global_blocks созданы
- Базовый PageEditScreen (но использует устаревший формат контента)
- Разрешения в Rbac.php: platform.page_builder

### ❌ Что нужно создать/исправить

- Экраны управления глобальными блоками (List + Edit)
- Page Builder интерфейс для страниц
- Предпросмотр страниц
- Маршруты для глобальных блоков
- Пункты меню в PlatformProvider

## Детальный план реализации

### 1. Глобальные блоки

**Файлы для создания:**

- `src/app/Orchid/Screens/GlobalBlock/GlobalBlockListScreen.php`
- `src/app/Orchid/Screens/GlobalBlock/GlobalBlockEditScreen.php`

**Типы глобальных блоков:**

- CTA-формы (контакты, заявки)
- Блоки контактов
- Блоки преимуществ
- Блоки "О компании"
- Социальные ссылки

**Поля для редактирования:**

- code (уникальный код для вставки)
- title (название блока)
- content (JSON с настройками блока)
- is_active (включен/выключен)

### 2. Page Builder для страниц

**Обновления PageEditScreen:**

- Замена устаревшего формата content на sections
- Интерфейс drag & drop для секций
- Предпросмотр страниц

**Типы секций для page builder:**

1. **Hero секция** - заголовок, подзаголовок, изображение, CTA кнопки
2. **Текстовая секция** - заголовок + текст
3. **Сетка категорий** - товары/категории с изображениями
4. **Список услуг** - карточки услуг с иконками
5. **Портфолио** - превью кейсов с фильтрацией
6. **CTA секция** - форма заявки или призыв к действию
7. **Контакты** - блок с контактной информацией
8. **Галерея** - сетка изображений
9. **Преимущества** - список преимуществ с иконками
10. **Глобальный блок** - вставка существующего глобального блока

### 3. Структура секций Page Builder

**JSON формат sections:**

```json
{
  "sections": [
    {
      "type": "hero",
      "order": 1,
      "settings": {
        "title": "Заголовок",
        "subtitle": "Подзаголовок",
        "background_image": "image_id",
        "cta_buttons": [...]
      }
    },
    {
      "type": "text",
      "order": 2,
      "settings": {
        "title": "Заголовок секции",
        "content": "Текст секции"
      }
    }
  ]
}
```

### 4. Интерфейс Page Builder

**Возможности:**

- Drag & drop порядок секций
- Добавление/удаление секций
- Настройки каждой секции
- Предпросмотр в реальном времени
- Сохранение как шаблон

### 5. Предпросмотр страниц

**Механизм:**

- Генерация preview_token для неопубликованных страниц
- Отдельный маршрут /preview/{token}
- Временное отображение без публикации

### 6. Интеграция с меню

**Обновления в PlatformProvider:**

- Добавление пункта "Глобальные блоки"
- Настройка доступа по правам platform.page_builder

### 7. Маршруты

**Добавление в routes/platform.php:**

- Управление глобальными блоками
- Предпросмотр страниц

## Этапы реализации

### Этап 1: Глобальные блоки

1. GlobalBlockListScreen + GlobalBlockEditScreen
2. Маршруты для глобальных блоков
3. Интеграция в PlatformProvider

### Этап 2: Page Builder интерфейс

1. Обновление PageEditScreen
2. Page Builder компоненты
3. Drag & Drop функциональность

### Этап 3: Предпросмотр

1. PreviewToken модель/функциональность
2. Preview маршруты
3. Интеграция в PageEditScreen

### Этап 4: Тестирование и финальная интеграция

1. Тестирование всех функций
2. Проверка drag & drop
3. Проверка предпросмотра
4. Финальная интеграция с меню

## Технические детали

### Типы секций и их настройки

1. **Hero секция**
   - title, subtitle, background_image
   - cta_buttons (массив кнопок)

2. **Текстовая секция**
   - title, content, alignment

3. **Сетка категорий**
   - category_ids, columns_count, show_count

4. **Список услуг**
   - service_ids, layout_type (grid/list)

5. **Портфолио**
   - case_ids, limit, show_filters

6. **CTA секция**
   - form_type, title, description

7. **Контакты**
   - contact_type (embedded/custom)
   - custom_content

8. **Галерея**
   - image_ids, columns_count, lightbox

9. **Преимущества**
   - items (массив с icon, title, text)

10. **Глобальный блок**
    - block_code (ссылка на GlobalBlock)

### Компоненты Orchid

- **Layout::view()** - для кастомных шаблонов секций
- **Input::make()** - для настроек секций
- **Select::make()** - для выбора типов секций
- **Picture::make()** - для изображений
- **Switcher::make()** - для булевых настроек

### JavaScript для drag & drop

- Sortable.js для drag & drop
- AJAX для сохранения порядка
- Live preview обновления

## Результат

После выполнения плана у нас будет:

1. ✅ Полнофункциональный Page Builder для страниц
2. ✅ Система глобальных блоков с переиспользованием
3. ✅ Предпросмотр страниц
4. ✅ Drag & Drop интерфейс
5. ✅ Интеграция с админ-панелью
