# План завершения задачи №5: Page Builder и глобальные блоки

## Анализ текущего состояния

### ✅ Что уже реализовано

1. **Модели и структура данных:**
   - Модель `Page` с полем `sections` (JSON array)
   - Модель `GlobalBlock` с полем `content` (JSON array)
   - Миграции для страниц с preview_token

2. **Orchid экраны:**
   - `PageListScreen` - список страниц с фильтрами
   - `PageEditScreen` - редактирование с базовым page builder
   - `GlobalBlockListScreen` - управление глобальными блоками

3. **Шаблоны и отображение:**
   - Основной шаблон `preview/page.blade.php` для рендеринга страниц
   - 10 шаблонов секций в `preview/sections/`
   - JavaScript интерфейс управления секциями

4. **Типы секций:**
   - hero, text, categories_grid, services_list, portfolio, cta_form, contacts, gallery, advantages, global_block

### ✅ Что было выполнено

#### 1. Backend функциональность Page Builder

- [x] Доработать метод `addSection` в `PageEditScreen`
- [x] Реализовать удаление и переупорядочивание секций
- [x] Добавить валидацию секций
- [x] Исправить сохранение секций в метод `save`

#### 2. Frontend интеграция

- [x] Исправить JavaScript для корректной работы с секциями
- [x] Добавить drag & drop функциональность (через кнопки вверх/вниз)
- [x] Улучшить UX добавления/редактирования секций
- [x] Интегрировать выпадающие списки для выбора данных

#### 3. Глобальные блоки

- [x] Создать экран редактирования глобальных блоков
- [x] Реализовать предпросмотр глобальных блоков
- [x] Добавить интеграцию с page builder

#### 4. Система предпросмотра

- [x] Создать маршруты для предпросмотра страниц
- [x] Реализовать механизм генерации preview_token
- [x] Создать контроллер для обработки предпросмотра

#### 5. Интеграция с данными

- [x] Подключить реальные данные для секций (категории, услуги, кейсы)
- [x] Добавить поиск и фильтрацию для выбора элементов
- [x] Реализовать загрузку медиа для секций

#### 6. Тестирование

- [ ] Проверить создание и редактирование страниц
- [ ] Проверить предпросмотр страниц
- [ ] Проверить глобальные блоки
- [ ] Протестировать drag & drop

## Детальный план реализации

### Этап 1: Backend функциональность (1-2 часа)

1. **Обновить PageEditScreen:**
   - Реализовать методы `addSection`, `removeSection`, `reorderSections`
   - Исправить метод `save` для корректного сохранения секций
   - Добавить валидацию структуры секций

2. **Создать контроллер предпросмотра:**
   - Создать `PreviewController` для обработки preview маршрутов
   - Реализовать генерацию и валидацию preview_token

3. **Обновить маршруты:**
   - Добавить маршруты для предпросмотра в `routes/web.php`
   - Обновить маршруты page builder в `routes/platform.php`

### Этап 2: Frontend улучшения (2-3 часа)

1. **Улучшить JavaScript page builder:**
   - Исправить динамическое добавление секций
   - Реализовать drag & drop с Sortable.js
   - Добавить валидацию на фронтенде

2. **Обновить шаблоны секций:**
   - Подключить реальные данные для секций
   - Добавить поиск и фильтрацию
   - Улучшить UX редактирования

### Этап 3: Глобальные блоки (1 час)

1. **Создать GlobalBlockEditScreen:**
   - CRUD для глобальных блоков
   - Поддержка JSON контента
   - Предпросмотр блоков

2. **Интеграция с page builder:**
   - Добавить выбор глобальных блоков в секции
   - Проверка циклических ссылок

### Этап 4: Интеграция и тестирование (1-2 часа)

1. **Полное тестирование:**
   - Создание тестовой страницы с разными секциями
   - Проверка предпросмотра
   - Тестирование глобальных блоков

2. **Оптимизация и финальные штрихи:**
   - Проверка производительности
   - Добавление help текстов
   - Обновление документации

## Критерии готовности

- [ ] Можно создавать страницы с разными типами секций
- [ ] Секции можно переупорядочивать (drag & drop)
- [ ] Глобальные блоки интегрированы в page builder
- [ ] Предпросмотр страниц работает корректно
- [ ] Все типы секций отображаются правильно
- [ ] Нет ошибок в консоли браузера
- [ ] Функциональность протестирована end-to-end

## Ожидаемый результат

Полнофункциональный page builder, позволяющий:

- Создавать страницы с помощью drag & drop секций
- Использовать глобальные блоки для переиспользования контента
- Предварительно просматривать собранные страницы
- Управлять всем контентом через удобный интерфейс

## Следующие шаги

1. **Начать с исправления backend функциональности**
2. **Протестировать базовое добавление секций**
3. **Добавить drag & drop функциональность**
4. **Реализовать предпросмотр страниц**
5. **Интегрировать глобальные блоки**
6. **Провести полное тестирование**
