# План исправления несоответствий в проекте Narrativ

## Анализ текущего состояния

### Обнаруженные критические несоответствия

#### 1. LeadDedupIndex - несоответствие схемы БД и кода

**Проблема:** В коде используются поля `email_hash` и `phone_hash`, которых не существует в БД.

**Схема БД (правильная):**

- `lead_id` (FK)
- `contact_key` (string) - универсальный ключ для дедупликации
- `created_date` (date) - дата для группировки по дням

**Код с ошибками:**

- `ImportExportSeeder.php` - строки 317-322
- `LeadImporter.php` - метод `createDedupIndex()` - строки 382-388

#### 2. Несоответствие в подходах к дедупликации

**ContentSeeder.php** - использует правильный подход с `contact_key`
**ImportExportSeeder.php и LeadImporter.php** - используют несуществующие поля

#### 3. Preview token конфликт

**Проблема:** Две миграции добавляют разные типы полей `preview_token`:

- `2025_12_26_160000_add_preview_tokens_and_admin_audits.php` - UUID
- `2025_12_27_120000_add_preview_token_to_pages_table.php` - string(32)

## Детальный план исправления

### ЭТАП 1: Исправление LeadDedupIndex (критично - блокирует миграцию)

#### 1.1 Исправить ImportExportSeeder.php

```php
// БЫЛО (строки 317-322):
LeadDedupIndex::updateOrCreate(
    ['lead_id' => $lead->id],
    [
        'email_hash' => hash('sha256', $lead->email),
        'phone_hash' => hash('sha256', $lead->phone),
        'created_at' => now(),
    ]
);

// ДОЛЖНО БЫТЬ:
$contactKey = $lead->email ? 'email:' . strtolower($lead->email) : 'phone:' . preg_replace('/\D+/', '', (string) $lead->phone);
LeadDedupIndex::updateOrCreate(
    ['lead_id' => $lead->id],
    [
        'contact_key' => $contactKey,
        'created_date' => $lead->created_at->toDateString(),
    ]
);
```

#### 1.2 Исправить LeadImporter.php

```php
// БЫЛО (строки 382-388):
LeadDedupIndex::updateOrCreate(
    ['lead_id' => $lead->id],
    [
        'email_hash' => ! empty($data['email']) ? hash('sha256', $data['email']) : null,
        'phone_hash' => ! empty($data['phone']) ? hash('sha256', $data['phone']) : null,
        'created_at' => now(),
    ]
);

// ДОЛЖНО БЫТЬ:
$contactKey = !empty($data['email']) ? 'email:' . strtolower($data['email']) : 'phone:' . preg_replace('/\D+/', '', (string) $data['phone']);
LeadDedupIndex::updateOrCreate(
    ['lead_id' => $lead->id],
    [
        'contact_key' => $contactKey,
        'created_date' => now()->toDateString(),
    ]
);
```

### ЭТАП 2: Устранение конфликта preview_token

#### 2.1 Удалить дублирующую миграцию

- Удалить `2025_12_27_120000_add_preview_token_to_pages_table.php`
- Оставить только `2025_12_26_160000_add_preview_tokens_and_admin_audits.php` (с UUID)

#### 2.2 Проверить модели на соответствие UUID типу

- Убедиться, что все модели используют `Str::orderedUuid()` для генерации

### ЭТАП 3: Стандартизация констант для enum полей

#### 3.1 Создать классы констант

```php
// Создать App\Enums\LeadStatus.php
// Создать App\Enums\FormCode.php  
// Создать App\Enums\PageStatus.php
// Создать App\Enums\ProductStatus.php
```

#### 3.2 Обновить модели для использования констант

- Добавить `const` в модели или использовать PHP 8.1+ enum

#### 3.3 Обновить сидеры для использования констант

### ЭТАП 4: Проверка других несоответствий

#### 4.1 Проверить User модель

- В коде есть поля `telegram_id`, `telegram_chat_id`, `telegram_verified_at`
- Убедиться, что они есть в миграции

#### 4.2 Проверить MediaLink и MenuItem модели

- Убедиться, что полиморфные связи работают корректно

### ЭТАП 5: Тестирование и валидация

#### 5.1 После каждого исправления

```bash
docker-compose exec php-fpm php artisan migrate:fresh --seed
```

#### 5.2 Проверить тесты

```bash
docker-compose exec php-fpm php artisan test
```

#### 5.3 Проверить Orchid админку

- Открыть приложение в браузере
- Проверить отсутствие 500 ошибок

### ЭТАП 6: Добавление защитных механизмов

#### 6.1 Создать artisan команду для проверки схемы

```bash
php artisan make:command SchemaLint
```

#### 6.2 Добавить тесты для проверки соответствия схемы

## Ожидаемые результаты

1. ✅ `docker-compose exec php-fpm php artisan migrate:fresh --seed` - успешно
2. ✅ `docker-compose exec php-fpm php artisan test` - успешно  
3. ✅ Приложение открывается без 500 ошибок
4. ✅ Orchid админка работает корректно
5. ✅ Дедупликация лидов работает по правильной схеме
6. ✅ Консистентность между схемой, моделями, сидерами и Orchid

## Файлы для изменения

### Приоритет 1 (критично - блокирует миграцию)

- `src/database/seeders/ImportExportSeeder.php`
- `src/app/Services/ImportExport/LeadImporter.php`

### Приоритет 2 (исправление архитектуры)

- `src/database/migrations/2025_12_27_120000_add_preview_token_to_pages_table.php` (удалить)
- Создать enum классы для статусов
- Обновить модели для использования констант

### Приоритет 3 (проверка и тестирование)

- Проверить User модель и миграцию
- Проверить MediaLink и MenuItem модели
- Создать SchemaLint команду
- Добавить тесты валидации схемы
